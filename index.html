<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        /* ── Light Theme ── */
        [data-theme="light"] {
            --bg: #faf8f5;
            --surface: #ffffff;
            --surface-hover: #f5f0eb;
            --border: #e8e2da;
            --border-subtle: #f0ebe4;

            --text: #3a3530;
            --text-sec: #7a7570;
            --text-dim: #b0a99f;

            --accent: #e08a5e;
            --accent-soft: rgba(224, 138, 94, 0.10);
            --accent-glow: rgba(224, 138, 94, 0.20);

            --card-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.03);
            --card-shadow-hover: 0 2px 8px rgba(0,0,0,0.07), 0 6px 20px rgba(0,0,0,0.04);

            --ev1: #e07a6a; --ev2: #e0a05e; --ev3: #9b8ed8;
            --ev4: #6bc0a0; --ev5: #d4a84b; --ev6: #d87a9e;
            --ev7: #6aaed4; --ev8: #8bb870;

            --overlay-bg: rgba(0,0,0,0.25);
            --settings-bg: #ffffff;
        }

        /* ── Dark Theme ── */
        [data-theme="dark"] {
            --bg: #1a1816;
            --surface: #242120;
            --surface-hover: #2e2a28;
            --border: #3a3532;
            --border-subtle: #2e2a28;

            --text: #ece9e2;
            --text-sec: #8e8a80;
            --text-dim: #5a5650;

            --accent: #e08a5e;
            --accent-soft: rgba(224, 138, 94, 0.12);
            --accent-glow: rgba(224, 138, 94, 0.25);

            --card-shadow: 0 1px 3px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.10);
            --card-shadow-hover: 0 2px 8px rgba(0,0,0,0.20), 0 6px 20px rgba(0,0,0,0.12);

            --ev1: #c47060; --ev2: #c89050; --ev3: #8a7ec5;
            --ev4: #5aad8c; --ev5: #c09540; --ev6: #c06a8a;
            --ev7: #5a9cc0; --ev8: #7aaa60;

            --overlay-bg: rgba(0,0,0,0.55);
            --settings-bg: #242120;
        }

        html, body {
            height: 100%; width: 100%;
            overflow: hidden;
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.35s, color 0.35s;
        }

        .dashboard {
            position: relative; z-index: 1;
            display: flex; flex-direction: column;
            height: 100vh; width: 100vw;
        }

        /* ── Header ── */
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 1.5vw;
            height: 52px; min-height: 48px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            background: var(--surface);
        }
        .header-left {
            display: flex; align-items: center; gap: 0.4vw;
        }
        .year-display {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.6vw; font-weight: 400;
            letter-spacing: 0.08em;
            color: var(--text);
            line-height: 1;
        }
        .year-nav {
            background: none; border: none;
            color: var(--text-dim);
            font-size: 1.2vw; cursor: pointer;
            padding: 0.2vw 0.35vw;
            border-radius: 6px;
            transition: color 0.2s, background 0.2s;
            line-height: 1;
        }
        .year-nav:hover { color: var(--accent); background: var(--accent-soft); }

        .header-center {
            font-size: 0.82vw; font-weight: 400;
            color: var(--text-sec);
            letter-spacing: 0.03em;
        }
        .header-right {
            display: flex; align-items: center; gap: 0.7vw;
        }
        .clock {
            font-size: 0.75vw; font-weight: 500;
            color: var(--text-sec);
            font-variant-numeric: tabular-nums;
        }
        .refresh-status {
            display: flex; align-items: center; gap: 0.3vw;
            font-size: 0.58vw; color: var(--text-dim);
        }
        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            background: var(--text-dim);
            flex-shrink: 0;
        }
        .status-dot.connected { background: #6ba66b; }
        .status-dot.syncing { background: #c0a040; animation: blink 1s infinite; }
        .status-dot.error { background: #c06060; }

        .theme-toggle {
            background: none; border: none;
            color: var(--text-dim);
            font-size: 1.05vw; cursor: pointer;
            transition: color 0.3s, transform 0.3s;
            padding: 0.2vw;
            line-height: 1;
            border-radius: 6px;
        }
        .theme-toggle:hover { color: var(--accent); transform: rotate(15deg); }

        .settings-btn {
            background: none; border: none;
            color: var(--text-dim);
            font-size: 1vw; cursor: pointer;
            transition: color 0.3s;
            padding: 0.2vw;
            line-height: 1;
            border-radius: 6px;
        }
        .settings-btn:hover { color: var(--accent); }
        .settings-btn.pulse {
            animation: settingsPulse 3s ease-in-out infinite;
        }

        /* ── Filter Bar (year view only) ── */
        .filter-bar {
            display: none;
            align-items: center;
            gap: 0.5vw;
            padding: 0.35vw 1.5vw;
            background: var(--surface);
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .filter-bar.visible {
            display: flex;
        }
        .filter-toggle {
            display: flex;
            align-items: center;
            gap: 0.3vw;
            padding: 0.2vw 0.55vw;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.6vw;
            cursor: pointer;
            transition: all 0.25s;
            user-select: none;
        }
        .filter-toggle:hover {
            border-color: var(--text-sec);
            color: var(--text-sec);
        }
        .filter-toggle.active {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
        }
        .filter-icon {
            font-size: 0.65vw;
            line-height: 1;
        }

        /* ── Breadcrumb ── */
        .breadcrumb-bar {
            display: none;
            align-items: center;
            gap: 0.4vw;
            padding: 0.5vw 1.5vw;
            font-size: 0.78vw;
            color: var(--text-sec);
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .breadcrumb-bar.visible {
            display: flex;
        }
        .breadcrumb-sep {
            color: var(--text-dim);
            font-size: 0.7vw;
        }
        .breadcrumb-link {
            background: none; border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78vw;
            color: var(--accent);
            cursor: pointer;
            padding: 0.15vw 0.3vw;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .breadcrumb-link:hover { background: var(--accent-soft); }
        .breadcrumb-current {
            color: var(--text);
            font-weight: 500;
        }
        .breadcrumb-back {
            background: none; border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.82vw;
            color: var(--text-dim);
            cursor: pointer;
            padding: 0.15vw 0.4vw;
            border-radius: 4px;
            margin-right: 0.3vw;
            transition: color 0.2s, background 0.2s;
        }
        .breadcrumb-back:hover { color: var(--accent); background: var(--accent-soft); }

        /* ── View Container ── */
        .view-container {
            flex: 1;
            min-height: 0;
            position: relative;
            overflow: hidden;
        }

        /* ── Calendar Grid (Year View) ── */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 0.6vw;
            padding: 0.6vw;
            height: 100%;
            min-height: 0;
        }

        /* ── Month Card ── */
        .month-card {
            background: var(--surface);
            display: flex; flex-direction: column;
            padding: 0.5vw 0.5vw 0.3vw;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            animation: monthReveal 0.45s ease-out both;
            cursor: pointer;
            transition: box-shadow 0.25s, transform 0.25s;
        }
        .month-card:hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-1px);
        }
        .month-card.current {
            border: 1.5px solid var(--accent);
            box-shadow: var(--card-shadow), 0 0 0 1px var(--accent-soft);
        }

        .month-name {
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.88vw; font-weight: 400;
            color: var(--text);
            letter-spacing: 0.08em;
            padding-bottom: 0.2vw;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 0.15vw;
        }
        .month-card.current .month-name {
            color: var(--accent);
        }

        .weekday-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.42vw; font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.12vw 0;
        }

        /* ── Days Grid ── */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            flex: 1;
            gap: 1px;
            min-height: 0;
        }

        .day-cell {
            position: relative;
            padding: 1px 2px;
            display: flex; flex-direction: column;
            overflow: hidden;
            min-height: 0;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .day-cell:not(.empty):hover {
            background: var(--surface-hover);
        }
        .day-cell.weekend .day-num {
            color: var(--text-dim);
        }
        .day-cell.past {
            opacity: 0.50;
        }
        .day-cell.today {
            background: var(--accent-soft);
            animation: todayBreath 6s ease-in-out infinite;
        }
        .day-cell.today .day-num {
            color: var(--accent);
            font-weight: 600;
        }

        .day-num {
            font-size: 0.60vw;
            font-weight: 400;
            color: var(--text-sec);
            line-height: 1.3;
            flex-shrink: 0;
        }

        /* ── Events (Year View) ── */
        .day-events {
            display: flex; flex-direction: column;
            gap: 0;
            min-height: 0;
            overflow: hidden;
            flex: 1;
            position: relative;
        }
        .day-events-track {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .day-events-track.scrolling {
            animation: eventScroll var(--scroll-dur, 10s) ease-in-out infinite;
            animation-delay: var(--scroll-delay, 0s);
        }
        @keyframes eventScroll {
            0%, 15% { transform: translateY(0); }
            42%, 58% { transform: translateY(var(--scroll-dist, 0)); }
            85%, 100% { transform: translateY(0); }
        }

        .event-item {
            font-size: 0.40vw;
            line-height: 1.25;
            padding: 1px 0 1px 0.22vw;
            border-left: 2px solid var(--evt-color, var(--ev1));
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            white-space: normal;
            word-break: break-word;
            color: var(--text-sec);
            margin-top: 1px;
            flex-shrink: 0;
            border-radius: 0 2px 2px 0;
        }
        .event-more {
            font-size: 0.38vw;
            color: var(--text-dim);
            margin-top: 1px;
            padding-left: 0.24vw;
            flex-shrink: 0;
        }

        /* ── Month View ── */
        .month-view {
            display: flex; flex-direction: column;
            height: 100%;
            padding: 1vw 2vw;
            animation: viewFadeIn 0.3s ease-out;
        }
        .month-view-header {
            display: flex; align-items: center; justify-content: center;
            gap: 1vw;
            margin-bottom: 0.8vw;
            flex-shrink: 0;
        }
        .month-view-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2vw; font-weight: 400;
            letter-spacing: 0.08em;
            color: var(--text);
        }
        .month-view-nav {
            background: none; border: none;
            color: var(--text-dim);
            font-size: 1.4vw; cursor: pointer;
            padding: 0.3vw 0.5vw;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
            line-height: 1;
        }
        .month-view-nav:hover { color: var(--accent); background: var(--accent-soft); }

        .month-view-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.7vw; font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.4vw 0;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .month-view-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            flex: 1;
            gap: 0.3vw;
            padding-top: 0.3vw;
            min-height: 0;
        }
        .month-day-cell {
            background: var(--surface);
            border-radius: 10px;
            padding: 0.35vw 0.4vw;
            display: flex; flex-direction: column;
            overflow: hidden;
            min-height: 0;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
            box-shadow: var(--card-shadow);
        }
        .month-day-cell:not(.empty):hover {
            box-shadow: var(--card-shadow-hover);
            transform: translateY(-1px);
        }
        .month-day-cell.empty {
            background: transparent;
            box-shadow: none;
            cursor: default;
        }
        .month-day-cell.today {
            border: 1.5px solid var(--accent);
            background: var(--accent-soft);
        }
        .month-day-cell.past {
            opacity: 0.55;
        }
        .month-day-cell.weekend .month-day-num {
            color: var(--text-dim);
        }
        .month-day-num {
            font-size: 0.85vw;
            font-weight: 500;
            color: var(--text-sec);
            margin-bottom: 0.2vw;
            flex-shrink: 0;
        }
        .month-day-cell.today .month-day-num {
            color: var(--accent);
            font-weight: 600;
        }
        .month-day-events {
            display: flex; flex-direction: column;
            gap: 2px;
            overflow: hidden;
            flex: 1;
            min-height: 0;
        }
        .month-event-item {
            font-size: 0.62vw;
            line-height: 1.35;
            padding: 2px 0 2px 0.35vw;
            border-left: 2.5px solid var(--evt-color, var(--ev1));
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-sec);
            border-radius: 0 3px 3px 0;
            flex-shrink: 0;
        }
        .month-event-more {
            font-size: 0.55vw;
            color: var(--text-dim);
            padding-left: 0.35vw;
            flex-shrink: 0;
        }

        /* ── Week View ── */
        .week-view {
            display: flex; flex-direction: column;
            height: 100%;
            padding: 0.8vw 1.2vw;
            animation: viewFadeIn 0.3s ease-out;
        }
        .week-view-header {
            display: flex; align-items: center; justify-content: center;
            gap: 1vw;
            margin-bottom: 0.6vw;
            flex-shrink: 0;
        }
        .week-view-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8vw; font-weight: 400;
            letter-spacing: 0.06em;
            color: var(--text);
        }
        .week-view-nav {
            background: none; border: none;
            color: var(--text-dim);
            font-size: 1.3vw; cursor: pointer;
            padding: 0.3vw 0.5vw;
            border-radius: 8px;
            transition: color 0.2s, background 0.2s;
            line-height: 1;
        }
        .week-view-nav:hover { color: var(--accent); background: var(--accent-soft); }

        .week-view-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            flex: 1;
            gap: 0.4vw;
            min-height: 0;
        }
        .week-day-col {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: flex; flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }
        .week-day-col.today {
            border: 1.5px solid var(--accent);
        }
        .week-day-col.past {
            opacity: 0.6;
        }
        .week-day-col-header {
            padding: 0.45vw 0.5vw;
            text-align: center;
            border-bottom: 1px solid var(--border-subtle);
            flex-shrink: 0;
        }
        .week-day-col.today .week-day-col-header {
            background: var(--accent-soft);
        }
        .week-day-col-name {
            font-size: 0.6vw;
            font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .week-day-col-num {
            font-size: 1.3vw;
            font-weight: 500;
            color: var(--text-sec);
            line-height: 1.3;
        }
        .week-day-col.today .week-day-col-num {
            color: var(--accent);
            font-weight: 600;
        }
        .week-day-events {
            flex: 1;
            overflow-y: auto;
            padding: 0.3vw;
            display: flex;
            flex-direction: column;
            gap: 0.25vw;
        }
        .week-event-card {
            padding: 0.3vw 0.4vw;
            border-left: 3px solid var(--evt-color, var(--ev1));
            border-radius: 0 8px 8px 0;
            background: var(--bg);
            transition: background 0.2s;
        }
        .week-event-card:hover {
            background: var(--surface-hover);
        }
        .week-event-time {
            font-size: 0.58vw;
            font-weight: 500;
            color: var(--accent);
            margin-bottom: 1px;
        }
        .week-event-title {
            font-size: 0.68vw;
            color: var(--text);
            line-height: 1.3;
        }
        .week-event-duration {
            font-size: 0.52vw;
            color: var(--text-dim);
            margin-top: 1px;
        }
        .week-empty {
            text-align: center;
            padding: 1vw 0.3vw;
            color: var(--text-dim);
            font-size: 0.6vw;
            opacity: 0.5;
        }

        /* ── Settings Panel ── */
        .settings-overlay {
            position: fixed; inset: 0;
            background: var(--overlay-bg);
            z-index: 100;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .settings-overlay.open {
            opacity: 1; pointer-events: auto;
        }

        .settings-panel {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 360px; max-width: 90vw;
            background: var(--settings-bg);
            border-left: 1px solid var(--border);
            z-index: 101;
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .settings-panel.open {
            transform: translateX(0);
        }

        .settings-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        .settings-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 20px; font-weight: 400;
            letter-spacing: 0.06em;
        }
        .settings-close {
            background: none; border: none;
            color: var(--text-dim);
            font-size: 22px; cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }
        .settings-close:hover { color: var(--text); }

        .settings-body {
            padding: 24px;
            flex: 1; overflow-y: auto;
        }
        .settings-field {
            margin-bottom: 20px;
        }
        .settings-field label {
            display: block;
            font-size: 11px; font-weight: 500;
            color: var(--text-sec);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }
        .settings-field input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-field input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-soft);
        }
        .settings-field input::placeholder {
            color: var(--text-dim);
        }
        .settings-hint {
            display: block;
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 6px;
            line-height: 1.4;
        }

        .settings-save {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            border: none; border-radius: 8px;
            color: #fff;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px; font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.15s;
            letter-spacing: 0.03em;
        }
        .settings-save:hover { opacity: 0.9; transform: translateY(-1px); }

        .settings-info {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        .settings-info-row {
            display: flex; justify-content: space-between;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        .settings-info-row span:last-child {
            color: var(--text-sec);
        }

        .settings-shortcuts {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        .settings-shortcuts h3 {
            font-size: 10px; font-weight: 500;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }
        .shortcut-row {
            display: flex; justify-content: space-between;
            font-size: 12px; color: var(--text-dim);
            margin-bottom: 6px;
        }
        .shortcut-key {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 1px 7px;
            font-size: 11px;
            font-family: monospace;
            color: var(--text-sec);
        }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ── Animations ── */
        @keyframes monthReveal {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes viewFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes todayBreath {
            0%, 100% { background: var(--accent-soft); }
            50% { background: var(--accent-glow); }
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        @keyframes settingsPulse {
            0%, 100% { color: var(--text-dim); }
            50% { color: var(--accent); }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header class="header">
            <div class="header-left">
                <button class="year-nav" id="prevNav" title="Previous">&#8249;</button>
                <h1 class="year-display" id="yearDisplay"></h1>
                <button class="year-nav" id="nextNav" title="Next">&#8250;</button>
            </div>
            <div class="header-center" id="currentDate"></div>
            <div class="header-right">
                <span class="clock" id="clock"></span>
                <span class="refresh-status">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">No calendar</span>
                </span>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme">&#9788;</button>
                <button class="settings-btn" id="settingsBtn" title="Settings (S)">&#9881;</button>
            </div>
        </header>
        <div class="filter-bar" id="filterBar">
            <button class="filter-toggle" id="autoScrollToggle" title="Auto-scroll through all events in year view">
                <span class="filter-icon">&#8597;</span> Auto-scroll
            </button>
            <button class="filter-toggle" id="hideRecurringToggle" title="Hide weekly recurring events in year view">
                <span class="filter-icon">&#8635;</span> Hide recurring
            </button>
        </div>
        <div class="breadcrumb-bar" id="breadcrumbBar"></div>
        <div class="view-container" id="viewContainer"></div>
    </div>

    <div class="settings-overlay" id="settingsOverlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="settings-close" id="settingsClose">&times;</button>
        </div>
        <div class="settings-body">
            <div class="settings-field">
                <label>Calendar URL (ICS)</label>
                <input type="url" id="icsUrlInput" placeholder="https://outlook.office365.com/owa/calendar/...">
                <span class="settings-hint">Paste the ICS sharing link from Outlook. Go to Calendar Settings &rarr; Shared calendars &rarr; Publish a calendar.</span>
            </div>
            <div class="settings-field">
                <label>CORS Proxy</label>
                <input type="text" id="corsProxyInput" placeholder="https://api.allorigins.win/raw?url=">
                <span class="settings-hint">Required to fetch external calendars from the browser. The URL you enter will be prefixed to your calendar URL. Leave blank to try direct fetch.</span>
            </div>
            <button class="settings-save" id="settingsSave">Save &amp; Sync</button>
            <div class="settings-info" id="settingsInfo">
                <div class="settings-info-row">
                    <span>Status</span>
                    <span id="infoStatus">Not configured</span>
                </div>
                <div class="settings-info-row">
                    <span>Events loaded</span>
                    <span id="infoEvents">0</span>
                </div>
                <div class="settings-info-row">
                    <span>Last sync</span>
                    <span id="infoLastSync">&mdash;</span>
                </div>
                <div class="settings-info-row">
                    <span>Next sync</span>
                    <span id="infoNextSync">&mdash;</span>
                </div>
            </div>
            <div class="settings-shortcuts">
                <h3>Keyboard Shortcuts</h3>
                <div class="shortcut-row"><span>Open settings</span> <span class="shortcut-key">S</span></div>
                <div class="shortcut-row"><span>Go to today</span> <span class="shortcut-key">T</span></div>
                <div class="shortcut-row"><span>Previous / Next</span> <span class="shortcut-key">&larr; &rarr;</span></div>
                <div class="shortcut-row"><span>Go back</span> <span class="shortcut-key">Esc</span></div>
                <div class="shortcut-row"><span>Toggle theme</span> <span class="shortcut-key">D</span></div>
            </div>
        </div>
    </div>

    <script>
    class CalendarDashboard {
        constructor() {
            this.events = {};
            this.icsUrl = localStorage.getItem('cal_icsUrl') || '';
            this.corsProxy = localStorage.getItem('cal_corsProxy') || 'https://api.allorigins.win/raw?url=';
            this.year = new Date().getFullYear();
            this.lastRefresh = null;
            this.nextRefresh = null;
            this.refreshTimer = null;
            this.eventCount = 0;
            this.settingsOpen = false;

            // View state: year, month, or week
            this.viewState = { mode: 'year', month: null, day: null };

            // Theme
            this.theme = localStorage.getItem('cal_theme') || 'light';
            document.documentElement.setAttribute('data-theme', this.theme);
            this.updateThemeIcon();

            // Toggles
            this.autoScroll = localStorage.getItem('cal_autoScroll') === 'true';
            this.hideRecurring = localStorage.getItem('cal_hideRecurring') === 'true';

            this.months = ['January','February','March','April','May','June',
                           'July','August','September','October','November','December'];

            this.init();
        }

        init() {
            this.render();
            this.updateHeader();
            this.startClock();
            this.bindEvents();
            this.applySettingsState();
            this.syncToggleUI();

            if (this.icsUrl) {
                this.fetchAndParse();
                this.scheduleRefresh();
            }

            this.scheduleMidnightUpdate();
        }

        /* ── Theme ── */

        toggleTheme() {
            this.theme = this.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', this.theme);
            localStorage.setItem('cal_theme', this.theme);
            this.updateThemeIcon();
        }

        updateThemeIcon() {
            const btn = document.getElementById('themeToggle');
            if (!btn) return;
            btn.innerHTML = this.theme === 'light' ? '&#9789;' : '&#9788;';
            btn.title = this.theme === 'light' ? 'Switch to dark theme' : 'Switch to light theme';
        }

        /* ── Toggles ── */

        toggleAutoScroll() {
            this.autoScroll = !this.autoScroll;
            localStorage.setItem('cal_autoScroll', this.autoScroll);
            this.syncToggleUI();
            if (this.viewState.mode === 'year') this.render();
        }

        toggleHideRecurring() {
            this.hideRecurring = !this.hideRecurring;
            localStorage.setItem('cal_hideRecurring', this.hideRecurring);
            this.syncToggleUI();
            if (this.viewState.mode === 'year') this.render();
        }

        syncToggleUI() {
            const asBtn = document.getElementById('autoScrollToggle');
            const hrBtn = document.getElementById('hideRecurringToggle');
            asBtn.classList.toggle('active', this.autoScroll);
            hrBtn.classList.toggle('active', this.hideRecurring);
        }

        /* ── View Management ── */

        render() {
            const container = document.getElementById('viewContainer');
            container.innerHTML = '';

            switch (this.viewState.mode) {
                case 'year':
                    this.renderYearView(container);
                    break;
                case 'month':
                    this.renderMonthView(container);
                    break;
                case 'week':
                    this.renderWeekView(container);
                    break;
            }

            this.updateBreadcrumb();
            this.updateNavButtons();
            this.updateFilterBar();
        }

        updateFilterBar() {
            const bar = document.getElementById('filterBar');
            if (this.viewState.mode === 'year') {
                bar.classList.add('visible');
            } else {
                bar.classList.remove('visible');
            }
        }

        updateBreadcrumb() {
            const bar = document.getElementById('breadcrumbBar');
            bar.innerHTML = '';

            if (this.viewState.mode === 'year') {
                bar.classList.remove('visible');
                return;
            }

            bar.classList.add('visible');

            // Back button
            const back = document.createElement('button');
            back.className = 'breadcrumb-back';
            back.innerHTML = '&#8592;';
            back.title = 'Go back';
            back.addEventListener('click', () => this.navigateBack());
            bar.appendChild(back);

            // Year link
            const yearLink = document.createElement('button');
            yearLink.className = 'breadcrumb-link';
            yearLink.textContent = this.year;
            yearLink.addEventListener('click', () => this.goToYear());
            bar.appendChild(yearLink);

            const sep1 = document.createElement('span');
            sep1.className = 'breadcrumb-sep';
            sep1.textContent = '\u203A';
            bar.appendChild(sep1);

            if (this.viewState.mode === 'month') {
                const monthLabel = document.createElement('span');
                monthLabel.className = 'breadcrumb-current';
                monthLabel.textContent = this.months[this.viewState.month];
                bar.appendChild(monthLabel);
            } else if (this.viewState.mode === 'week') {
                const monthLink = document.createElement('button');
                monthLink.className = 'breadcrumb-link';
                monthLink.textContent = this.months[this.viewState.month];
                monthLink.addEventListener('click', () => this.goToMonth(this.viewState.month));
                bar.appendChild(monthLink);

                const sep2 = document.createElement('span');
                sep2.className = 'breadcrumb-sep';
                sep2.textContent = '\u203A';
                bar.appendChild(sep2);

                const weekStart = new Date(this.year, this.viewState.month, this.viewState.day);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);

                const weekLabel = document.createElement('span');
                weekLabel.className = 'breadcrumb-current';
                weekLabel.textContent = this.fmtWeekRange(weekStart, weekEnd);
                bar.appendChild(weekLabel);
            }
        }

        fmtWeekRange(start, end) {
            const sMonth = start.toLocaleDateString('en-US', { month: 'short' });
            const eMonth = end.toLocaleDateString('en-US', { month: 'short' });
            if (start.getMonth() === end.getMonth()) {
                return `${sMonth} ${start.getDate()}\u2013${end.getDate()}`;
            }
            return `${sMonth} ${start.getDate()} \u2013 ${eMonth} ${end.getDate()}`;
        }

        updateNavButtons() {
            const label = document.getElementById('yearDisplay');
            if (this.viewState.mode === 'year') {
                label.textContent = this.year;
            } else if (this.viewState.mode === 'month') {
                label.textContent = `${this.months[this.viewState.month]} ${this.year}`;
            } else if (this.viewState.mode === 'week') {
                const weekStart = new Date(this.year, this.viewState.month, this.viewState.day);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                label.textContent = this.fmtWeekRange(weekStart, weekEnd) + ', ' + this.year;
            }
        }

        goToYear() {
            this.viewState = { mode: 'year', month: null, day: null };
            this.render();
        }

        goToMonth(month) {
            this.viewState = { mode: 'month', month: month, day: null };
            this.render();
        }

        goToWeek(month, day) {
            // Compute Sunday of the week containing the given date
            const date = new Date(this.year, month, day);
            const dow = date.getDay();
            const sunday = new Date(date);
            sunday.setDate(sunday.getDate() - dow);

            // Handle if Sunday falls in previous year
            if (sunday.getFullYear() < this.year) {
                // Keep the week anchored to current year's first day
                sunday.setFullYear(this.year);
                sunday.setMonth(0);
                sunday.setDate(1);
                const d = sunday.getDay();
                sunday.setDate(sunday.getDate() - d);
            }

            this.viewState = {
                mode: 'week',
                month: sunday.getMonth(),
                day: sunday.getDate()
            };
            // If week start is in different year, adjust
            if (sunday.getFullYear() !== this.year) {
                this.year = sunday.getFullYear();
                this.events = {};
                if (this.icsUrl) this.fetchAndParse();
            }
            this.render();
        }

        navigateBack() {
            switch (this.viewState.mode) {
                case 'week':
                    this.goToMonth(this.viewState.month);
                    break;
                case 'month':
                    this.goToYear();
                    break;
            }
        }

        navigatePrev() {
            switch (this.viewState.mode) {
                case 'year':
                    this.year--;
                    this.events = {};
                    this.render();
                    if (this.icsUrl) this.fetchAndParse();
                    break;
                case 'month':
                    if (this.viewState.month === 0) {
                        this.year--;
                        this.viewState.month = 11;
                        this.events = {};
                        if (this.icsUrl) this.fetchAndParse();
                    } else {
                        this.viewState.month--;
                    }
                    this.render();
                    break;
                case 'week': {
                    const ws = new Date(this.year, this.viewState.month, this.viewState.day);
                    ws.setDate(ws.getDate() - 7);
                    if (ws.getFullYear() !== this.year) {
                        this.year = ws.getFullYear();
                        this.events = {};
                        if (this.icsUrl) this.fetchAndParse();
                    }
                    this.viewState.month = ws.getMonth();
                    this.viewState.day = ws.getDate();
                    this.render();
                    break;
                }
            }
        }

        navigateNext() {
            switch (this.viewState.mode) {
                case 'year':
                    this.year++;
                    this.events = {};
                    this.render();
                    if (this.icsUrl) this.fetchAndParse();
                    break;
                case 'month':
                    if (this.viewState.month === 11) {
                        this.year++;
                        this.viewState.month = 0;
                        this.events = {};
                        if (this.icsUrl) this.fetchAndParse();
                    } else {
                        this.viewState.month++;
                    }
                    this.render();
                    break;
                case 'week': {
                    const ws = new Date(this.year, this.viewState.month, this.viewState.day);
                    ws.setDate(ws.getDate() + 7);
                    if (ws.getFullYear() !== this.year) {
                        this.year = ws.getFullYear();
                        this.events = {};
                        if (this.icsUrl) this.fetchAndParse();
                    }
                    this.viewState.month = ws.getMonth();
                    this.viewState.day = ws.getDate();
                    this.render();
                    break;
                }
            }
        }

        /* ── Year View ── */

        renderYearView(container) {
            const grid = document.createElement('div');
            grid.className = 'calendar-grid';
            const today = new Date();

            this.months.forEach((name, mi) => {
                const card = document.createElement('div');
                card.className = 'month-card';
                if (mi === today.getMonth() && this.year === today.getFullYear()) {
                    card.classList.add('current');
                }
                card.style.animationDelay = `${mi * 0.03}s`;

                card.addEventListener('click', () => this.goToMonth(mi));

                // Month name
                const mName = document.createElement('div');
                mName.className = 'month-name';
                mName.textContent = name;
                card.appendChild(mName);

                // Weekday headers
                const wRow = document.createElement('div');
                wRow.className = 'weekday-row';
                ['S','M','T','W','T','F','S'].forEach(d => {
                    const s = document.createElement('span');
                    s.textContent = d;
                    wRow.appendChild(s);
                });
                card.appendChild(wRow);

                // Days
                const dGrid = document.createElement('div');
                dGrid.className = 'days-grid';
                const firstDay = new Date(this.year, mi, 1).getDay();
                const daysInMonth = new Date(this.year, mi + 1, 0).getDate();

                for (let i = 0; i < firstDay; i++) {
                    dGrid.appendChild(this.makeYearCell(null));
                }

                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(this.year, mi, d);
                    const dow = date.getDay();
                    const isWeekend = dow === 0 || dow === 6;
                    const isToday = date.toDateString() === today.toDateString();
                    const isPast = date < today && !isToday;
                    const key = this.dateKey(date);
                    let dayEvts = this.events[key] || [];

                    // Filter recurring events if toggle is on
                    if (this.hideRecurring && dayEvts.length > 0) {
                        dayEvts = dayEvts.filter(e => !e.isRecurring);
                    }

                    const cell = this.makeYearCell(d, isWeekend, isToday, isPast, dayEvts);
                    dGrid.appendChild(cell);
                }

                const totalCells = firstDay + daysInMonth;
                for (let i = totalCells; i < 42; i++) {
                    dGrid.appendChild(this.makeYearCell(null));
                }

                card.appendChild(dGrid);
                grid.appendChild(card);
            });

            container.appendChild(grid);

            // Initialize auto-scroll after DOM paint
            if (this.autoScroll) {
                requestAnimationFrame(() => this.initAutoScroll());
            }
        }

        makeYearCell(day, isWeekend, isToday, isPast, events) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            if (day === null) { cell.classList.add('empty'); return cell; }

            if (isWeekend) cell.classList.add('weekend');
            if (isToday) cell.classList.add('today');
            if (isPast) cell.classList.add('past');

            const num = document.createElement('span');
            num.className = 'day-num';
            num.textContent = day;
            cell.appendChild(num);

            if (events && events.length > 0) {
                const evDiv = document.createElement('div');
                evDiv.className = 'day-events';
                const maxShow = 3;
                const shouldScroll = this.autoScroll && events.length > maxShow;
                const showEvents = shouldScroll ? events : events.slice(0, maxShow);

                const track = document.createElement('div');
                track.className = 'day-events-track';
                if (shouldScroll) {
                    track.classList.add('scrollable');
                }

                showEvents.forEach(ev => {
                    const item = document.createElement('div');
                    item.className = 'event-item';
                    item.style.setProperty('--evt-color', this.getColor(ev.summary));
                    let txt = '';
                    if (!ev.isAllDay && ev.time) {
                        txt = this.fmtTime(ev.time) + ' ';
                    }
                    txt += ev.summary;
                    item.textContent = txt;
                    track.appendChild(item);
                });

                evDiv.appendChild(track);

                if (!shouldScroll && events.length > maxShow) {
                    const more = document.createElement('div');
                    more.className = 'event-more';
                    more.textContent = `+${events.length - maxShow}`;
                    evDiv.appendChild(more);
                }

                cell.appendChild(evDiv);

                cell.title = events.map(e => {
                    const t = e.isAllDay ? 'All day' : this.fmtTimeFull(e.time);
                    return `${t}: ${e.summary}`;
                }).join('\n');
            }

            return cell;
        }

        initAutoScroll() {
            document.querySelectorAll('.day-events-track.scrollable').forEach((track, idx) => {
                const container = track.parentElement;
                const overflow = track.scrollHeight - container.clientHeight;
                if (overflow > 0) {
                    track.style.setProperty('--scroll-dist', `-${overflow}px`);
                    // Scale duration with content, min 6s, stagger delays
                    const duration = Math.max(6, Math.ceil(overflow / 3));
                    track.style.setProperty('--scroll-dur', `${duration}s`);
                    // Stagger so cells don't all scroll in sync
                    track.style.setProperty('--scroll-delay', `${(idx % 7) * 0.8}s`);
                    track.classList.add('scrolling');
                }
            });
        }

        /* ── Month View ── */

        renderMonthView(container) {
            const view = document.createElement('div');
            view.className = 'month-view';
            const today = new Date();
            const mi = this.viewState.month;

            // Header
            const header = document.createElement('div');
            header.className = 'month-view-header';

            const prevBtn = document.createElement('button');
            prevBtn.className = 'month-view-nav';
            prevBtn.innerHTML = '&#8249;';
            prevBtn.addEventListener('click', () => this.navigatePrev());

            const title = document.createElement('h2');
            title.className = 'month-view-title';
            title.textContent = `${this.months[mi]} ${this.year}`;

            const nextBtn = document.createElement('button');
            nextBtn.className = 'month-view-nav';
            nextBtn.innerHTML = '&#8250;';
            nextBtn.addEventListener('click', () => this.navigateNext());

            header.appendChild(prevBtn);
            header.appendChild(title);
            header.appendChild(nextBtn);
            view.appendChild(header);

            // Weekday row
            const wRow = document.createElement('div');
            wRow.className = 'month-view-weekdays';
            ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'].forEach(d => {
                const s = document.createElement('span');
                s.textContent = d;
                wRow.appendChild(s);
            });
            view.appendChild(wRow);

            // Day grid
            const grid = document.createElement('div');
            grid.className = 'month-view-grid';

            const firstDay = new Date(this.year, mi, 1).getDay();
            const daysInMonth = new Date(this.year, mi + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'month-day-cell empty';
                grid.appendChild(empty);
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(this.year, mi, d);
                const dow = date.getDay();
                const isWeekend = dow === 0 || dow === 6;
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;
                const key = this.dateKey(date);
                const dayEvts = this.events[key] || [];

                const cell = document.createElement('div');
                cell.className = 'month-day-cell';
                if (isWeekend) cell.classList.add('weekend');
                if (isToday) cell.classList.add('today');
                if (isPast) cell.classList.add('past');

                cell.addEventListener('click', () => this.goToWeek(mi, d));

                const num = document.createElement('div');
                num.className = 'month-day-num';
                num.textContent = d;
                cell.appendChild(num);

                if (dayEvts.length > 0) {
                    const evDiv = document.createElement('div');
                    evDiv.className = 'month-day-events';
                    const maxShow = 5;

                    dayEvts.slice(0, maxShow).forEach(ev => {
                        const item = document.createElement('div');
                        item.className = 'month-event-item';
                        item.style.setProperty('--evt-color', this.getColor(ev.summary));
                        let txt = '';
                        if (!ev.isAllDay && ev.time) {
                            txt = this.fmtTime(ev.time) + ' ';
                        }
                        txt += ev.summary;
                        item.textContent = txt;
                        evDiv.appendChild(item);
                    });

                    if (dayEvts.length > maxShow) {
                        const more = document.createElement('div');
                        more.className = 'month-event-more';
                        more.textContent = `+${dayEvts.length - maxShow} more`;
                        evDiv.appendChild(more);
                    }

                    cell.appendChild(evDiv);
                }

                grid.appendChild(cell);
            }

            const totalCells = firstDay + daysInMonth;
            for (let i = totalCells; i < 42; i++) {
                const empty = document.createElement('div');
                empty.className = 'month-day-cell empty';
                grid.appendChild(empty);
            }

            view.appendChild(grid);
            container.appendChild(view);
        }

        /* ── Week View ── */

        renderWeekView(container) {
            const view = document.createElement('div');
            view.className = 'week-view';
            const today = new Date();
            const weekStart = new Date(this.year, this.viewState.month, this.viewState.day);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            // Header
            const header = document.createElement('div');
            header.className = 'week-view-header';

            const prevBtn = document.createElement('button');
            prevBtn.className = 'week-view-nav';
            prevBtn.innerHTML = '&#8249;';
            prevBtn.addEventListener('click', () => this.navigatePrev());

            const title = document.createElement('h2');
            title.className = 'week-view-title';
            const rangeText = this.fmtWeekRange(weekStart, weekEnd);
            title.textContent = `${rangeText}, ${weekEnd.getFullYear()}`;

            const nextBtn = document.createElement('button');
            nextBtn.className = 'week-view-nav';
            nextBtn.innerHTML = '&#8250;';
            nextBtn.addEventListener('click', () => this.navigateNext());

            header.appendChild(prevBtn);
            header.appendChild(title);
            header.appendChild(nextBtn);
            view.appendChild(header);

            // 7-column grid
            const grid = document.createElement('div');
            grid.className = 'week-view-grid';

            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const key = this.dateKey(date);
                const dayEvts = this.events[key] || [];
                const isToday = date.toDateString() === today.toDateString();
                const isPast = date < today && !isToday;

                const col = document.createElement('div');
                col.className = 'week-day-col';
                if (isToday) col.classList.add('today');
                if (isPast) col.classList.add('past');

                // Column header
                const colHeader = document.createElement('div');
                colHeader.className = 'week-day-col-header';

                const dayName = document.createElement('div');
                dayName.className = 'week-day-col-name';
                dayName.textContent = date.toLocaleDateString('en-US', { weekday: 'short' });

                const dayNum = document.createElement('div');
                dayNum.className = 'week-day-col-num';
                dayNum.textContent = date.getDate();

                colHeader.appendChild(dayName);
                colHeader.appendChild(dayNum);
                col.appendChild(colHeader);

                // Events
                const evList = document.createElement('div');
                evList.className = 'week-day-events';

                if (dayEvts.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'week-empty';
                    empty.textContent = '\u2014';
                    evList.appendChild(empty);
                } else {
                    dayEvts.forEach(ev => {
                        const card = document.createElement('div');
                        card.className = 'week-event-card';
                        card.style.setProperty('--evt-color', this.getColor(ev.summary));

                        const timeEl = document.createElement('div');
                        timeEl.className = 'week-event-time';
                        timeEl.textContent = ev.isAllDay ? 'All day' : this.fmtTime(ev.time);
                        card.appendChild(timeEl);

                        const titleEl = document.createElement('div');
                        titleEl.className = 'week-event-title';
                        titleEl.textContent = ev.summary;
                        card.appendChild(titleEl);

                        if (!ev.isAllDay && ev.time && ev.endTime) {
                            const dur = document.createElement('div');
                            dur.className = 'week-event-duration';
                            dur.textContent = `${this.fmtTimeFull(ev.time)} \u2013 ${this.fmtTimeFull(ev.endTime)}`;
                            card.appendChild(dur);
                        }

                        evList.appendChild(card);
                    });
                }

                col.appendChild(evList);
                grid.appendChild(col);
            }

            view.appendChild(grid);
            container.appendChild(view);
        }

        /* ── ICS Fetch & Parse ── */

        async fetchAndParse() {
            if (!this.icsUrl) return;

            this.setStatus('syncing', 'Syncing...');

            try {
                const icsText = await this.fetchICS(this.icsUrl);
                this.parseICS(icsText);
                this.lastRefresh = new Date();
                this.setStatus('connected', `Synced ${this.fmtTimeFull(this.lastRefresh)}`);
                this.render();
                this.updateInfoPanel();
            } catch (err) {
                console.error('Calendar fetch error:', err);
                this.setStatus('error', err.message || 'Fetch failed');
            }
        }

        async fetchICS(url) {
            try {
                const resp = await fetch(url);
                if (resp.ok) {
                    const text = await resp.text();
                    if (text.includes('BEGIN:VCALENDAR')) return text;
                }
            } catch (e) { /* CORS likely, try proxy */ }

            if (this.corsProxy) {
                const proxyUrl = this.corsProxy + encodeURIComponent(url);
                const resp = await fetch(proxyUrl);
                if (!resp.ok) throw new Error(`Proxy returned ${resp.status}`);
                const text = await resp.text();
                if (!text.includes('BEGIN:VCALENDAR')) {
                    throw new Error('Response is not valid ICS data');
                }
                return text;
            }

            throw new Error('CORS blocked \u2014 configure a proxy in settings');
        }

        parseICS(icsText) {
            if (typeof ICAL === 'undefined') {
                throw new Error('ICAL library not loaded');
            }

            this.events = {};
            this.eventCount = 0;

            const jcal = ICAL.parse(icsText);
            const comp = new ICAL.Component(jcal);
            const vevents = comp.getAllSubcomponents('vevent');

            const yearStart = new Date(this.year, 0, 1);
            const yearEnd = new Date(this.year, 11, 31, 23, 59, 59);

            for (const vevent of vevents) {
                try {
                    const event = new ICAL.Event(vevent);

                    if (event.isRecurring()) {
                        this.expandRecurring(event, yearStart, yearEnd);
                    } else {
                        this.expandSingle(event, yearStart, yearEnd);
                    }
                } catch (e) {
                    console.warn('Skipping event:', e.message);
                }
            }
        }

        expandRecurring(event, yearStart, yearEnd) {
            const iter = event.iterator();
            let next;
            let safety = 0;

            while ((next = iter.next()) && safety < 2000) {
                safety++;
                const start = next.toJSDate();
                if (start > yearEnd) break;

                if (start >= yearStart) {
                    const endTime = event.endDate && !event.startDate.isDate
                        ? new Date(start.getTime() + (event.endDate.toJSDate().getTime() - event.startDate.toJSDate().getTime()))
                        : null;
                    this.addEvent(start, {
                        summary: event.summary || '(No Title)',
                        time: event.startDate.isDate ? null : start,
                        endTime: endTime,
                        isAllDay: event.startDate.isDate,
                        isRecurring: true,
                    });
                }
            }
        }

        expandSingle(event, yearStart, yearEnd) {
            const start = event.startDate.toJSDate();
            const end = event.endDate.toJSDate();

            if (end < yearStart || start > yearEnd) return;

            const startDay = new Date(start);
            startDay.setHours(0, 0, 0, 0);
            const endDay = new Date(end);
            endDay.setHours(0, 0, 0, 0);

            if (event.startDate.isDate || (end.getHours() === 0 && end.getMinutes() === 0 && endDay > startDay)) {
                endDay.setDate(endDay.getDate() - 1);
            }

            const current = new Date(startDay);
            while (current <= endDay) {
                if (current >= yearStart && current <= yearEnd) {
                    this.addEvent(new Date(current), {
                        summary: event.summary || '(No Title)',
                        time: event.startDate.isDate ? null : start,
                        endTime: event.startDate.isDate ? null : end,
                        isAllDay: event.startDate.isDate,
                        isRecurring: false,
                    });
                }
                current.setDate(current.getDate() + 1);
            }
        }

        addEvent(date, entry) {
            const key = this.dateKey(date);
            if (!this.events[key]) this.events[key] = [];

            const isDup = this.events[key].some(e =>
                e.summary === entry.summary &&
                ((!e.time && !entry.time) ||
                 (e.time && entry.time && e.time.getTime() === entry.time.getTime()))
            );
            if (isDup) return;

            this.events[key].push(entry);
            this.eventCount++;

            this.events[key].sort((a, b) => {
                if (a.isAllDay && !b.isAllDay) return -1;
                if (!a.isAllDay && b.isAllDay) return 1;
                if (a.time && b.time) return a.time.getTime() - b.time.getTime();
                return 0;
            });
        }

        /* ── Helpers ── */

        dateKey(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        getColor(summary) {
            const colors = [
                'var(--ev1)','var(--ev2)','var(--ev3)','var(--ev4)',
                'var(--ev5)','var(--ev6)','var(--ev7)','var(--ev8)'
            ];
            let h = 0;
            const s = summary || '';
            for (let i = 0; i < s.length; i++) {
                h = s.charCodeAt(i) + ((h << 5) - h);
                h = h & h;
            }
            return colors[Math.abs(h) % colors.length];
        }

        fmtTime(d) {
            if (!d) return '';
            const h = d.getHours(), m = d.getMinutes();
            const suf = h >= 12 ? 'p' : 'a';
            const h12 = h % 12 || 12;
            return m === 0 ? `${h12}${suf}` : `${h12}:${String(m).padStart(2,'0')}${suf}`;
        }

        fmtTimeFull(d) {
            if (!d) return '';
            return d.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        }

        /* ── Status & UI ── */

        setStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const label = document.getElementById('statusText');
            dot.className = 'status-dot ' + state;
            label.textContent = text;
            document.getElementById('infoStatus').textContent = text;
        }

        updateInfoPanel() {
            document.getElementById('infoEvents').textContent = this.eventCount;
            if (this.lastRefresh) {
                document.getElementById('infoLastSync').textContent = this.fmtTimeFull(this.lastRefresh);
            }
            if (this.nextRefresh) {
                document.getElementById('infoNextSync').textContent = this.fmtTimeFull(this.nextRefresh);
            }
        }

        updateHeader() {
            const now = new Date();
            const opts = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', opts);
        }

        startClock() {
            const tick = () => {
                const now = new Date();
                document.getElementById('clock').textContent =
                    now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit', second: '2-digit' });
            };
            tick();
            setInterval(tick, 1000);
        }

        applySettingsState() {
            const btn = document.getElementById('settingsBtn');
            if (!this.icsUrl) {
                btn.classList.add('pulse');
            } else {
                btn.classList.remove('pulse');
            }
            document.getElementById('icsUrlInput').value = this.icsUrl;
            document.getElementById('corsProxyInput').value = this.corsProxy;
        }

        /* ── Auto Refresh ── */

        scheduleRefresh() {
            if (this.refreshTimer) clearTimeout(this.refreshTimer);
            const interval = 15 * 60 * 1000;
            this.nextRefresh = new Date(Date.now() + interval);
            this.updateInfoPanel();

            this.refreshTimer = setTimeout(() => {
                this.fetchAndParse();
                this.scheduleRefresh();
            }, interval);
        }

        scheduleMidnightUpdate() {
            const now = new Date();
            const midnight = new Date(now);
            midnight.setHours(24, 0, 0, 0);
            const ms = midnight.getTime() - now.getTime() + 1000;

            setTimeout(() => {
                const today = new Date();
                if (today.getFullYear() !== this.year) {
                    this.year = today.getFullYear();
                }
                this.updateHeader();
                this.render();
                this.scheduleMidnightUpdate();
            }, ms);
        }

        /* ── Settings Panel ── */

        openSettings() {
            this.settingsOpen = true;
            document.getElementById('settingsPanel').classList.add('open');
            document.getElementById('settingsOverlay').classList.add('open');
            document.getElementById('icsUrlInput').focus();
        }

        closeSettings() {
            this.settingsOpen = false;
            document.getElementById('settingsPanel').classList.remove('open');
            document.getElementById('settingsOverlay').classList.remove('open');
        }

        saveSettings() {
            const url = document.getElementById('icsUrlInput').value.trim();
            const proxy = document.getElementById('corsProxyInput').value.trim();

            this.icsUrl = url;
            this.corsProxy = proxy;
            localStorage.setItem('cal_icsUrl', url);
            localStorage.setItem('cal_corsProxy', proxy);

            this.applySettingsState();

            if (url) {
                this.fetchAndParse();
                this.scheduleRefresh();
            } else {
                this.events = {};
                this.eventCount = 0;
                this.render();
                this.setStatus('', 'No calendar');
                if (this.refreshTimer) clearTimeout(this.refreshTimer);
            }

            this.closeSettings();
        }

        /* ── Event Binding ── */

        bindEvents() {
            document.getElementById('settingsBtn').addEventListener('click', () => this.openSettings());
            document.getElementById('settingsClose').addEventListener('click', () => this.closeSettings());
            document.getElementById('settingsOverlay').addEventListener('click', () => this.closeSettings());
            document.getElementById('settingsSave').addEventListener('click', () => this.saveSettings());
            document.getElementById('themeToggle').addEventListener('click', () => this.toggleTheme());
            document.getElementById('autoScrollToggle').addEventListener('click', () => this.toggleAutoScroll());
            document.getElementById('hideRecurringToggle').addEventListener('click', () => this.toggleHideRecurring());

            document.getElementById('prevNav').addEventListener('click', () => this.navigatePrev());
            document.getElementById('nextNav').addEventListener('click', () => this.navigateNext());

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (this.settingsOpen) {
                    if (e.key === 'Escape') this.closeSettings();
                    return;
                }
                if (e.target.tagName === 'INPUT') return;

                switch(e.key) {
                    case 's': case 'S': this.openSettings(); break;
                    case 'd': case 'D': this.toggleTheme(); break;
                    case 't': case 'T':
                        this.year = new Date().getFullYear();
                        this.viewState = { mode: 'year', month: null, day: null };
                        this.events = {};
                        this.render();
                        if (this.icsUrl) this.fetchAndParse();
                        break;
                    case 'Escape':
                        this.navigateBack();
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        this.navigatePrev();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        this.navigateNext();
                        break;
                }
            });

            document.getElementById('icsUrlInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') this.saveSettings();
            });
        }
    }

    // Launch
    const dashboard = new CalendarDashboard();
    </script>
</body>
</html>
